{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Panel de Administración</h1>
    
    <!-- Fila 1: Resumen general -->
    <div class="row mt-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Usuarios Totales</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-users">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Usuarios Activos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="active-users">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Nuevos (últimos 30 días)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="new-users">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fila 2: Gráficas principales -->
    <div class="row">
        <!-- Gráfica de distribución por género -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Distribución por Género</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfica de distribución por edad -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Distribución por Edad</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar pt-4 pb-2">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fila 3: Más gráficas -->
    <div class="row">
        <!-- Gráfica de tipos de seguimiento -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Tipos de Seguimiento</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="trackingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfica de síntomas más frecuentes -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Síntomas Más Frecuentes</h6>
                </div>
                <div class="card-body">
                    <div class="chart-bar pt-4 pb-2">
                        <canvas id="symptomsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Incluye Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Función para cargar los datos del dashboard - VERSIÓN MEJORADA
function loadDashboardData() {
    fetch('/api/estadisticas/')
        .then(response => {
            if (!response.ok) throw new Error('Error en respuesta del servidor');
            return response.json();
        })
        .then(data => {
            console.log('Endpoints recibidos:', data.endpoints); // Debug

            // Actualizar métricas
            document.getElementById('total-users').textContent = data.total_usuarios;
            document.getElementById('active-users').textContent = data.usuarios_activos;
            document.getElementById('new-users').textContent = data.usuarios_nuevos_ultimo_mes;

            // Cargar gráficas
            const loaders = [
                loadChartData(data.endpoints.genero_usuarios, 'genderChart', 'pie'),
                loadChartData(data.endpoints.edades, 'ageChart', 'bar'),
                loadChartData(data.endpoints.seguimiento, 'trackingChart', 'pie'),
                loadChartData(data.endpoints.sintomas_frecuentes, 'symptomsChart', 'bar')
            ];

            return Promise.allSettled(loaders);
        })
        .then(results => {
            console.log('Resultados de carga de gráficas:', results); // Debug
            const failed = results.filter(r => r.status === 'rejected');
            if (failed.length > 0) {
                console.error('Algunas gráficas fallaron:', failed);
            }
        })
        .catch(error => {
            console.error('Error general:', error);
            alert('Error al cargar datos. Ver consola para detalles.');
        });
}

// Función genérica para cargar datos de gráficas
function loadChartData(url, canvasId, chartType) {
    console.log(`Cargando gráfico ${canvasId} desde ${url}`); // Debug

    fetch(url)
        .then(response => {
            console.log(`Respuesta para ${canvasId}:`, response.status); // Debug
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`Datos recibidos para ${canvasId}:`, data); // Debug
            if (!data.labels || !data.data) {
                throw new Error('Datos incompletos recibidos del servidor');
            }
            renderChart(canvasId, data.labels, data.data, chartType, data.titulo || '');
        })
        .catch(error => {
            console.error(`Error al cargar ${canvasId}:`, error);
            const card = document.getElementById(canvasId).closest('.card');
            if (card) {
                card.innerHTML = `
                    <div class="alert alert-danger p-3">
                        <strong>Error en gráfico de síntomas:</strong><br>
                        ${error.message}<br>
                        <small>URL: ${url}</small>
                    </div>
                `;
            }
        });
}
// Función para renderizar gráficas
function renderChart(canvasId, labels, data, type, title) {
    const ctx = document.getElementById(canvasId).getContext('2d');

    // Configuración común
    const commonOptions = {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: title,
            },
        },
    };

    // Configuración específica por tipo
    if (type === 'pie' || type === 'doughnut') {
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: commonOptions
        });
    } else if (type === 'bar') {
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cantidad',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Cargar los datos cuando la página esté lista
// Verificación inicial de elementos del DOM
document.addEventListener('DOMContentLoaded', () => {
    console.log('Verificando elementos del DOM...');
    const elements = {
        'genderChart': 'Género',
        'ageChart': 'Edades',
        'trackingChart': 'Seguimiento',
        'symptomsChart': 'Síntomas'
    };

    for (const [id, name] of Object.entries(elements)) {
        const element = document.getElementById(id);
        console.log(`${name}:`, element ? 'Encontrado' : 'NO ENCONTRADO');
    }

    loadDashboardData();
});
</script>

<style>
.card {
    border-radius: 0.35rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.shadow {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}

.chart-area, .chart-pie, .chart-bar {
    position: relative;
    height: 300px;
    width: 100%;
}
canvas {
    min-height: 250px;
    width: 100% !important;
    height: auto !important;
}

.chart-container {
    position: relative;
    margin: auto;
    height: 300px;
    width: 100%;
}
#symptomsChart {
    min-height: 250px;
    width: 100%;
    display: block;
    background-color: #f8f9fa; /* Fondo temporal para visualización */
    border: 1px dashed #ccc; /* Borde temporal para debug */
}

/* Mensaje de error */
.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
}
</style>

{% endblock %}